<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In - Lunara Portal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font Family -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Lucide Icons for aesthetic elements -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Tailwind Configuration for the theme */
        :root {
            --color-indigo-600: #4f46e5;
            --color-indigo-500: #6366f1;
            --color-gray-900: #111827;
            --color-gray-800: #1f2937;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-gray-900);
            min-height: 100vh;
        }
        .auth-form-card {
            max-width: 462px;
            border-left-width: 0px;
            border-right-width: 0px;
            border-bottom-width: 0px;
            padding-bottom: 0px;
            padding-top: 0px;
        }
        /* Style for the custom toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 100;
            font-weight: 600;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .toast-success {
            background-color: #10B981; /* Green-500 */
        }
        .toast-error {
            background-color: #EF4444; /* Red-500 */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header (Navigation) -->
    <header id="header" class="fixed top-0 left-0 w-full z-40 bg-gray-900/95 backdrop-blur-sm shadow-lg border-b border-indigo-900/50">
        <div class="container mx-auto px-4 max-w-7xl h-16 flex items-center justify-between">
            <a href="#" data-action="go-home" class="flex items-center space-x-2 text-xl font-bold text-white tracking-widest" onclick="handleNavigation('home'); return false;">
                <i data-lucide="rocket" class="w-5 h-5 text-indigo-400"></i>
                <span>LUNARA</span>
            </a>
            <div class="header-buttons space-x-3">
                <button onclick="handleNavigation('sign-up')" class="btn px-4 py-1.5 text-sm font-bold text-white bg-indigo-600 rounded-lg hover:bg-indigo-500 transition duration-200 shadow-md">
                    Sign Up
                </button>
            </div>
            <!-- Mobile Menu Button - Minimal on Sign In page -->
            <button id="mobile-menu-btn" class="md:hidden p-2 text-gray-300 hover:text-white transition duration-200" aria-label="Toggle mobile menu" aria-expanded="false" onclick="toggleMobileMenu()">
                <i data-lucide="menu" class="w-6 h-6 mobile-icon-open"></i>
                <i data-lucide="x" class="w-6 h-6 mobile-icon-close hidden"></i>
            </button>
        </div>
    </header>

    <!-- Main Content: Sign In Form -->
    <main class="flex-grow flex items-center justify-center py-20 mt-16 px-4">
        <div class="auth-form-card mx-auto">
            <div class="bg-gray-800 p-8 md:p-12 rounded-xl shadow-2xl border border-gray-700/50">
                    
                    <div class="text-center">
                        <i data-lucide="user" class="w-12 h-12 text-indigo-400 mx-auto p-2 bg-gray-700 rounded-full shadow-inner"></i>
                        <h1 class="text-3xl font-extrabold text-white mt-4">
                            Welcome back!
                        </h1>
                        <p class="text-indigo-300 mt-1">Your workspace is waiting âœ¨</p>
                    </div>

                    <form class="auth-form mt-8 space-y-5" id="signin-form">
                        <!-- Error/Loading message area -->
                        <div id="auth-status" class="hidden p-3 rounded-lg text-sm font-medium transition duration-300"></div>

                        <div class="form-group">
                            <label for="email" class="sr-only">Email</label>
                            <div class="relative">
                                <i data-lucide="at-sign" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-500"></i>
                                <input 
                                    type="email" 
                                    id="email" 
                                    placeholder="Enter your email" 
                                    required 
                                    class="w-full pl-10 pr-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500 shadow-md transition duration-200"
                                >
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="password" class="sr-only">Password</label>
                            <div class="relative">
                                <i data-lucide="key" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-500"></i>
                                <input 
                                    type="password" 
                                    id="password" 
                                    placeholder="Passwordâ€¦ keep it secret ðŸ¤«" 
                                    required 
                                    class="w-full pl-10 pr-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500 shadow-md transition duration-200"
                                >
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center text-sm">
                            <label class="flex items-center text-gray-400 hover:text-white transition duration-200 cursor-pointer">
                                <input type="checkbox" id="remember-me" class="w-4 h-4 text-indigo-600 bg-gray-700 border-gray-600 rounded focus:ring-indigo-500 mr-2" /> 
                                Remember me
                            </label>
                            <a href="#" class="text-indigo-400 hover:text-indigo-300 transition duration-200 font-medium">
                                Forgot it? No worries ðŸ˜…
                            </a>
                        </div>

                        <button 
                            type="submit" 
                            id="submit-button"
                            class="btn-block w-full flex items-center justify-center px-4 py-3 text-lg font-bold text-white bg-indigo-600 rounded-lg hover:bg-indigo-500 transition duration-200 shadow-xl disabled:bg-indigo-400 disabled:cursor-not-allowed"
                        >
                            <i data-lucide="lock" class="w-5 h-5 mr-2"></i>
                            Log Me In
                        </button>

                        <p class="text-center text-gray-400 mt-6">
                            Don't have an account? 
                            <a href="#" data-action="sign-up" onclick="handleNavigation('sign-up'); return false;" class="ml-1 text-indigo-400 hover:text-indigo-300 transition duration-200 font-semibold">
                                Sign Up
                            </a>
                        </p>
                        <p class="text-center text-xs text-gray-500 pt-2 border-t border-gray-700/50">
                            ðŸ”’ Fast, secure login. Your workspace stays safe.
                        </p>
                    </form>
                </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="py-4 text-center text-xs text-gray-500 border-t border-gray-800">
        Lunara Portal (v1.0) - All rights reserved.
    </footer>

    <!-- Mobile Navigation Overlay (Minimal) -->
    <div id="mobile-nav-overlay" class="hidden fixed inset-0 bg-black/80 z-30 transition-opacity duration-300 md:hidden" onclick="toggleMobileMenu()">
        <div class="absolute top-16 right-0 w-3/4 max-w-xs bg-gray-800 p-6 shadow-xl rounded-bl-lg border-l border-b border-indigo-900" onclick="event.stopPropagation()">
            <a href="#" class="block text-lg font-medium py-2 text-gray-300 hover:text-white" onclick="handleNavigation('home'); toggleMobileMenu();">Home</a>
            <div class="mt-4 pt-4 border-t border-gray-700">
                <button onclick="handleNavigation('sign-up'); toggleMobileMenu();" class="w-full py-2 text-white bg-indigo-600 rounded-lg hover:bg-indigo-500 transition shadow-md">Sign Up</button>
            </div>
        </div>
    </div>


<script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Enable debug logging
    setLogLevel('Debug');

    // --- GLOBAL VARIABLES & INITIALIZATION ---
    // These variables are provided by the canvas environment
    const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : {};
    const __initial_auth_token = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;

    let app, auth;
    let authIsReady = false;
    let useFirebase = false;

    // UI Elements
    const signinForm = document.getElementById('signin-form');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const submitButton = document.getElementById('submit-button');
    const authStatusDiv = document.getElementById('auth-status');
    const originalButtonText = submitButton.innerHTML;

    // --- UTILITIES ---
    
    /**
     * Shows a custom toast notification.
     * @param {string} message 
     * @param {'success'|'error'} type 
     */
    window.showToast = function(message, type = 'info') {
        // Remove existing toasts
        document.querySelectorAll('.toast').forEach(toast => toast.remove());

        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        // Animate in
        setTimeout(() => {
            toast.style.transform = 'translateX(0)';
        }, 100);

        // Remove after 5 seconds
        setTimeout(() => {
            toast.style.transform = 'translateX(120%)';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 400); // Wait for transition
        }, 5000);
    }
    
    /**
     * Updates the status area above the form.
     * @param {string} message 
     * @param {'success'|'error'|'info'} type 
     * @param {boolean} showLoader 
     */
    function updateStatus(message, type, showLoader = false) {
        authStatusDiv.textContent = message;
        authStatusDiv.className = `p-3 rounded-lg text-sm font-medium transition duration-300`;
        
        if (type === 'error') {
            authStatusDiv.classList.add('bg-red-900/40', 'border', 'border-red-700', 'text-red-300');
        } else if (type === 'success') {
            authStatusDiv.classList.add('bg-green-900/40', 'border', 'border-green-700', 'text-green-300');
        } else { // info/loading
            authStatusDiv.classList.add('bg-indigo-900/40', 'border', 'border-indigo-700', 'text-indigo-300');
            if (showLoader) {
                authStatusDiv.innerHTML = `<span class="inline-block animate-spin mr-2"><i data-lucide="loader-2" class="w-4 h-4"></i></span> ${message}`;
                // Re-initialize lucide icons for the loader
                lucide.createIcons();
            }
        }
        authStatusDiv.classList.remove('hidden');
    }

    // --- FIREBASE INITIALIZATION ---
    // Initialize Firebase (optional - falls back to localStorage auth)
    try {
        if (firebaseConfig.apiKey) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            useFirebase = true;
            console.log('Firebase initialized successfully');
        } else {
            console.log('No Firebase config found, using localStorage auth');
            authIsReady = true;
        }
    } catch (e) {
        console.error("Firebase initialization failed:", e);
        console.log('Falling back to localStorage auth');
        authIsReady = true;
    }

    // --- AUTHENTICATION LOGIC ---

    // 1. Initial Authentication Check/Setup
    async function initializeAuth() {
        if (!auth) {
            // No Firebase, use localStorage
            authIsReady = true;
            submitButton.disabled = false;
            return;
        }

        try {
            updateStatus('Initializing connection...', 'info', true);
            
            // Try to sign in with custom token if available, otherwise sign in anonymously
            if (__initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
                console.log("Signed in with custom token.");
            } else {
                await signInAnonymously(auth);
                console.log("Signed in anonymously.");
            }
        } catch(error) {
            console.error("Initial sign-in failed:", error);
        }
        
        // Listen for auth state changes to determine readiness
        onAuthStateChanged(auth, (user) => {
            authIsReady = true;
            submitButton.disabled = false;
            authStatusDiv.classList.add('hidden'); // Hide status on load completion
            
            if (user && !user.isAnonymous) {
                // User is already signed in with a real account (e.g., persistent session)
                showToast('Session detected. Already signed in!', 'success');
                // In a real application, you would redirect to the dashboard here.
                console.log("User is already authenticated:", user.uid);
            }
        });
    }


    // 2. Sign In Handler
    async function handleSignIn(e) {
        e.preventDefault();

        if (!authIsReady && useFirebase) {
            showToast("Please wait for initialization to complete.", 'error');
            return;
        }

        const email = emailInput.value;
        const password = passwordInput.value;

        // Visual loading state
        submitButton.disabled = true;
        submitButton.innerHTML = `<span class="inline-block animate-spin mr-2"><i data-lucide="loader-2" class="w-5 h-5"></i></span> Signing In...`;
        lucide.createIcons();
        authStatusDiv.classList.add('hidden'); // Hide any prior status

        try {
            if (useFirebase) {
                // Use Firebase authentication
                await signInWithEmailAndPassword(auth, email, password);

                // Store auth token and redirect to React dashboard
                localStorage.setItem('auth_token', await auth.currentUser.getIdToken());
                localStorage.setItem('user_email', email);
            } else {
                // Fallback: Use localStorage-only authentication
                // In production, this would call your backend API
                console.log('Using localStorage auth for:', email);

                // Create a mock token for development
                const mockToken = btoa(JSON.stringify({ email, timestamp: Date.now() }));
                localStorage.setItem('auth_token', mockToken);
                localStorage.setItem('user_email', email);
            }

            // Success feedback
            showToast('Success! Welcome back, redirecting now...', 'success');
            updateStatus('Login successful. Redirecting...', 'success');

            setTimeout(() => {
                window.location.href = '/dashboard';
            }, 1000);

        } catch (error) {
            console.error('Login error:', error);

            let userMessage = 'Login failed. Please check your email and password.';
            if (error.code === 'auth/user-not-found') {
                userMessage = 'No account found with this email.';
            } else if (error.code === 'auth/wrong-password') {
                userMessage = 'Invalid password.';
            } else if (error.code === 'auth/too-many-requests') {
                userMessage = 'Access temporarily blocked due to too many failed attempts. Try again later.';
            }

            updateStatus(userMessage, 'error');
            showToast(userMessage, 'error');

        } finally {
            // Restore button state on failure
            if (!useFirebase || (auth?.currentUser?.isAnonymous || !auth?.currentUser)) {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
                lucide.createIcons();
            }
        }
    }

    // --- UI/NAVIGATION LOGIC ---

    /**
     * Simple client-side navigation handler (e.g., for header links)
     * In this single-page context, it just logs or scrolls.
     */
    window.handleNavigation = function(target) {
        console.log(`Navigation intended for: ${target}`);
        if (target === 'sign-up') {
            updateStatus("Sign-Up functionality would load here.", 'info');
            showToast("Sign-Up is pending implementation.", 'info');
        } else if (target === 'home') {
            console.log("This would navigate back to the landing page.");
        }
    }

    /**
     * Toggles the mobile menu overlay and icon.
     */
    window.toggleMobileMenu = function() {
        const overlay = document.getElementById('mobile-nav-overlay');
        const openIcon = document.querySelector('.mobile-icon-open');
        const closeIcon = document.querySelector('.mobile-icon-close');
        
        if (overlay.classList.contains('hidden')) {
            overlay.classList.remove('hidden');
            openIcon.classList.add('hidden');
            closeIcon.classList.remove('hidden');
        } else {
            overlay.classList.add('hidden');
            openIcon.classList.remove('hidden');
            closeIcon.classList.add('hidden');
        }
    }


    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        // Create initial lucide icons
        lucide.createIcons();
        
        // Disable button until Firebase is ready
        submitButton.disabled = true;
        
        // Initialize Firebase Auth
        initializeAuth();

        // Attach form submission handler
        signinForm.addEventListener('submit', handleSignIn);
    });

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script type="module" crossorigin src="/dist/js/main.js"></script>

</body>
</html>
