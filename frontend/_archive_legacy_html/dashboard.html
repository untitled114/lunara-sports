<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lunara - Dashboard</title>
<!-- Favicon and Icons -->
<link rel="icon" type="image/x-icon" href="favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<meta name="theme-color" content="#6366f1">

<!-- Essential Meta Tags for Security -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' https://images.unsplash.com data:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://unpkg.com https://cdn.skypack.dev; connect-src 'self' http://127.0.0.1:8000 http://localhost:8000 https://images.unsplash.com https://lunara-api.thankfulhill-c6015f7f.eastus.azurecontainerapps.io https://api.lunara-app.com;">
<meta name="robots" content="noindex, nofollow">
<meta name="view-transition" content="same-origin">

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Core Stylesheets -->
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/dashboard.css">
<link rel="stylesheet" href="/css/dashboard-authentic.css">

<!-- Turbo for SPA-like navigation -->
<script type="module">
  import hotwiredTurbo from 'https://cdn.jsdelivr.net/npm/@hotwired/turbo@8.0.12/+esm';
</script>
</head>
<body>

<!-- PLACEHOLDER: User authentication should be verified server-side before rendering this page -->

<header id="header">
  <div class="container">
    <div class="logo" data-action="dashboard" style="cursor: pointer;">Lunara</div>
    <nav class="nav" aria-label="Main navigation">
      <a href="#" class="nav-link active" data-action="dashboard">Dashboard</a>
      <a href="#" class="nav-link" data-action="projects">Projects <span class="nav-badge" id="projects-badge" style="display: none;">0</span></a>
      <a href="#" class="nav-link" data-action="payments">Payments <span class="nav-badge urgent" id="payments-badge" style="display: none;">0</span></a>
      <a href="#" class="nav-link" data-action="messages">Messages <span class="nav-badge" id="messages-badge" style="display: none;">0</span></a>
    </nav>
    <div class="header-buttons">
      <button class="btn-icon notification-btn urgent-pulse" title="Urgent notifications" aria-label="5 urgent notifications" data-action="notifications">
        üö®
        <span class="notification-badge urgent">5</span>
      </button>
      <a href="#" class="profile-mini" aria-label="View profile" data-action="profile">
        <img id="user-avatar-header" src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=40&h=40&fit=crop&crop=face" alt="User Avatar" loading="lazy" crossorigin="anonymous">
        <span id="user-name-header" data-user-name>Loading...</span>
      </a>
      <a href="#" class="btn btn-secondary" data-action="logout">Logout</a>
    </div>
    <button id="mobile-menu" class="mobile-menu" aria-label="Toggle mobile menu" aria-expanded="false">
      <span></span>
      <span></span>
      <span></span>
    </button>
  </div>
</header>

<!-- Critical Alert Banner -->
<div class="alert-banner critical">
  <div class="container">
    <div class="alert-content">
      <span class="alert-icon">‚ö†Ô∏è</span>
      <span class="alert-text"><strong>Payment Overdue:</strong> TechFlow's milestone payment is 3 days late. Automatic escrow release in 4 days.</span>
      <button class="alert-action">Contact Client</button>
      <button class="alert-dismiss" aria-label="Dismiss alert">&times;</button>
    </div>
  </div>
</div>

<main class="dashboard-main">
  <!-- Hero Welcome Section -->
  <section class="dashboard-hero">
    <div class="welcome-card container">
      <div class="welcome-content">
        <h1 id="dashboard-greeting">Loading... ‚ö°</h1>
        <p>You've got 3 client check-ins today and a milestone deadline tonight</p>
        <span class="last-login">Last active: <time datetime="2024-12-15T14:23:00">2 hours ago from Coffee Bean WiFi</time></span>
      </div>
      <div class="quick-stats">
        <div class="stat-item urgent" data-stat="overdue-tasks">
          <span class="stat-value" data-count="0">-</span>
          <span class="stat-label">Overdue</span>
        </div>
        <div class="stat-item warning" data-stat="due-today">
          <span class="stat-value" data-count="0">-</span>
          <span class="stat-label">Due Today</span>
        </div>
        <div class="stat-item success" data-stat="weekly-progress">
          <span class="stat-value" data-percentage="0">-</span>
          <span class="stat-label">Week Progress</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Dashboard Content -->
  <section class="dashboard-content">
    <div class="container">
      <div class="dashboard-grid">

        <!-- Main Content Area -->
        <div class="main-content">

          <!-- Urgent Actions Widget -->
          <div class="widget urgent-actions">
            <div class="widget-header">
              <h2>üî• Needs Your Attention</h2>
              <span class="urgency-indicator">4 urgent items</span>
            </div>
            <div class="urgent-list">
              <div class="urgent-item critical">
                <div class="urgent-icon">üí∏</div>
                <div class="urgent-content">
                  <div class="urgent-title">TechFlow payment is 3 days overdue</div>
                  <div class="urgent-subtitle">$2,400 milestone ‚Ä¢ Auto-release in 4 days</div>
                </div>
                <button class="btn-urgent" onclick="chasePayment('proj_tf_002')">Chase Payment</button>
              </div>
              <div class="urgent-item warning">
                <div class="urgent-icon">‚è∞</div>
                <div class="urgent-content">
                  <div class="urgent-title">HealthApp UI mockups due in 6 hours</div>
                  <div class="urgent-subtitle">Client expecting preview tonight</div>
                </div>
                <button class="btn-urgent" onclick="viewProject('proj_ha_001')">Work Now</button>
              </div>
              <div class="urgent-item info">
                <div class="urgent-icon">üí¨</div>
                <div class="urgent-content">
                  <div class="urgent-title">Sarah from EcoTech wants scope change</div>
                  <div class="urgent-subtitle">Requesting additional API endpoints</div>
                </div>
                <button class="btn-urgent" onclick="contactClient('ecotech')">Discuss</button>
              </div>
            </div>
          </div>

          <!-- Active Projects Widget -->
          <div class="widget active-projects">
            <div class="widget-header">
              <h2>Projects in Progress</h2>
              <a href="projects.html" class="view-all" id="view-all-projects" style="display: none;">View All</a>
            </div>
            <div id="project-list-container" class="project-list">
              <!-- Projects will be dynamically loaded here -->
              <div class="empty-state" id="projects-empty-state">
                <div class="empty-icon">üìã</div>
                <h3>No Active Projects</h3>
                <p>Create your first project to start collaborating with clients or freelancers.</p>
                <button class="btn btn-primary" onclick="showModal('new-project')">Create First Project</button>
              </div>
            </div>
          </div>

          <!-- Today's Timeline Widget -->
          <div class="widget timeline-widget">
            <div class="widget-header">
              <h2>Today's Schedule</h2>
              <span class="current-time">3:47 PM</span>
            </div>
            <div class="timeline-list">
              <!-- PLACEHOLDER: Schedule data should be loaded from calendar API -->
              <div class="timeline-item completed">
                <div class="timeline-time">9:00 AM</div>
                <div class="timeline-content">
                  <div class="timeline-title">‚úÖ Daily standup with EcoTech team</div>
                  <div class="timeline-note">Discussed API authentication approach</div>
                </div>
              </div>
              <div class="timeline-item completed">
                <div class="timeline-time">11:30 AM</div>
                <div class="timeline-content">
                  <div class="timeline-title">‚úÖ Code review - User management module</div>
                  <div class="timeline-note">Submitted changes, waiting for approval</div>
                </div>
              </div>
              <div class="timeline-item current">
                <div class="timeline-time">4:00 PM</div>
                <div class="timeline-content">
                  <div class="timeline-title">üéØ HealthApp UI mockup deadline</div>
                  <div class="timeline-note">2 screens left to finalize</div>
                </div>
              </div>
              <div class="timeline-item upcoming">
                <div class="timeline-time">6:00 PM</div>
                <div class="timeline-content">
                  <div class="timeline-title">üìû Client call - TechFlow payment discussion</div>
                  <div class="timeline-note">Prepare invoice and timeline</div>
                </div>
              </div>
              <div class="timeline-item upcoming">
                <div class="timeline-time">8:00 PM</div>
                <div class="timeline-content">
                  <div class="timeline-title">üìß Weekly client updates</div>
                  <div class="timeline-note">Send progress reports to all active clients</div>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- Sidebar -->
        <div class="sidebar">

          <!-- This Week's Reality Check -->
          <div class="widget reality-check">
            <h3>This Week's Reality</h3>
            <!-- PLACEHOLDER: Financial data should be loaded from secure API with proper validation -->
            <div class="earnings-amount" data-earnings="3200">$3,200</div>
            <div class="earnings-change mixed" data-change="-5">Behind target by $800</div>
            <div class="earnings-breakdown">
              <div class="breakdown-item">
                <span>Invoiced & Paid</span>
                <span class="amount positive" data-completed="1800">$1,800</span>
              </div>
              <div class="breakdown-item">
                <span>Work Done, Unpaid</span>
                <span class="amount warning" data-pending="2400">$2,400</span>
              </div>
              <div class="breakdown-item">
                <span>Coffee & Expenses</span>
                <span class="amount expense" data-expenses="127">-$127</span>
              </div>
            </div>
            <div class="week-goal">
              <div class="goal-progress">
                <span>Weekly Goal: $4,000</span>
                <span>80%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: 80%"></div>
              </div>
            </div>
          </div>

          <!-- Client Relationships Widget -->
          <div class="widget client-health">
            <h3>Client Pulse Check</h3>
            <div class="client-list">
              <!-- PLACEHOLDER: Client relationship data should be calculated from interaction patterns -->
              <div class="client-item happy">
                <img src="https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=40&h=40&fit=crop&crop=face" alt="Sarah - EcoTech" class="client-avatar" crossorigin="anonymous">
                <div class="client-info">
                  <div class="client-name">Sarah K. (EcoTech)</div>
                  <div class="client-mood">üòä Happy - paid early</div>
                </div>
                <div class="client-health-score green">9.2</div>
              </div>
              <div class="client-item neutral">
                <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=40&h=40&fit=crop&crop=face" alt="Dr. Martinez - HealthTech" class="client-avatar" crossorigin="anonymous">
                <div class="client-info">
                  <div class="client-name">Dr. Martinez (HealthTech)</div>
                  <div class="client-mood">üòê Neutral - deadline stress</div>
                </div>
                <div class="client-health-score yellow">7.1</div>
              </div>
              <div class="client-item problematic">
                <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=40&h=40&fit=crop&crop=face" alt="Mike - TechFlow" class="client-avatar" crossorigin="anonymous">
                <div class="client-info">
                  <div class="client-name">Mike R. (TechFlow)</div>
                  <div class="client-mood">üò§ Avoiding payments</div>
                </div>
                <div class="client-health-score red">3.8</div>
              </div>
            </div>
          </div>

          <!-- Quick Actions That Matter -->
          <div class="widget survival-actions">
            <h3>Survival Mode</h3>
            <div class="survival-grid">
              <button class="survival-action critical" onclick="chaseAllPayments()" aria-label="Chase all overdue payments">
                <div class="survival-icon">üí∏</div>
                <span>Chase Payments<br><small>$3,200 overdue</small></span>
              </button>
              <button class="survival-action urgent" onclick="sendClientUpdates()" aria-label="Send overdue client updates">
                <div class="survival-icon">üìß</div>
                <span>Client Updates<br><small>4 overdue</small></span>
              </button>
              <button class="survival-action normal" onclick="generateInvoices()" aria-label="Generate pending invoices">
                <div class="survival-icon">üßæ</div>
                <span>Send Invoices<br><small>2 ready</small></span>
              </button>
              <button class="survival-action normal" onclick="findNewWork()" aria-label="Find new projects">
                <div class="survival-icon">üéØ</div>
                <span>Find Work<br><small>Pipeline thin</small></span>
              </button>
            </div>
          </div>

          <!-- Recent Chaos -->
          <div class="widget chaos-feed">
            <div class="widget-header">
              <h3>What's Happening</h3>
              <span class="chaos-count">Live updates</span>
            </div>
            <div class="chaos-list">
              <!-- PLACEHOLDER: Real-time activity feed -->
              <div class="chaos-item urgent">
                <div class="chaos-time">12 min ago</div>
                <div class="chaos-content">
                  <span class="chaos-title">üí∏ TechFlow payment reminder bounced</span>
                  <span class="chaos-detail">Email delivery failed - invalid address</span>
                </div>
              </div>
              <div class="chaos-item warning">
                <div class="chaos-time">34 min ago</div>
                <div class="chaos-content">
                  <span class="chaos-title">üì± Dr. Martinez called twice</span>
                  <span class="chaos-detail">Probably about tonight's deadline</span>
                </div>
              </div>
              <div class="chaos-item positive">
                <div class="chaos-time">1 hour ago</div>
                <div class="chaos-content">
                  <span class="chaos-title">‚úÖ EcoTech approved database schema</span>
                  <span class="chaos-detail">$1,200 milestone unlocked</span>
                </div>
              </div>
              <div class="chaos-item normal">
                <div class="chaos-time">2 hours ago</div>
                <div class="chaos-content">
                  <span class="chaos-title">‚òï Working from Coffee Bean again</span>
                  <span class="chaos-detail">Home internet still down</span>
                </div>
              </div>
              <div class="chaos-item">
                <div class="chaos-time">3 hours ago</div>
                <div class="chaos-content">
                  <span class="chaos-title">üéâ Completed user auth module</span>
                  <span class="chaos-detail">2 hours ahead of schedule</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Quick Action Modal - More Realistic -->
<div class="modal" id="new-project-modal" role="dialog" aria-labelledby="modal-title" aria-hidden="true">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('new-project')" aria-label="Close modal">&times;</button>
    <h2 id="modal-title">Add New Project</h2>
    <div class="modal-note">üí° Tip: Use clear project names and always discuss scope before starting</div>
    <!-- PLACEHOLDER: Form should include CSRF protection and proper validation -->
    <form class="project-form" onsubmit="createProject(event)" novalidate>
      <div class="form-group">
        <label for="project-title">What are you building? *</label>
        <input type="text" id="project-title" name="title" placeholder="e.g., E-commerce mobile app for local bakery" required maxlength="100">
      </div>
      <div class="form-group">
        <label for="client-email">Client Contact *</label>
        <input type="email" id="client-email" name="clientEmail" placeholder="jane@awesomebakery.com" required>
      </div>
      <div class="form-group">
        <label for="project-value">Project Value (be realistic) *</label>
        <input type="number" id="project-value" name="value" placeholder="2500.00" step="0.01" min="1" required>
        <small>Remember: this should cover your time, revisions, and coffee money</small>
      </div>
      <div class="form-group">
        <label for="project-deadline">When do they want it?</label>
        <input type="date" id="project-deadline" name="deadline" min="2024-12-16">
      </div>
      <div class="form-group">
        <label for="project-description">Scope & Deliverables *</label>
        <textarea id="project-description" name="description" rows="4" placeholder="Be specific about what you're delivering. Include number of pages, features, revisions, etc. This saves headaches later." required maxlength="1000"></textarea>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="closeModal('new-project')">Maybe Later</button>
        <button type="submit" class="btn btn-primary">Let's Do This</button>
      </div>
    </form>
  </div>
</div>

<!-- Mobile Navigation Overlay -->
<div class="mobile-nav-overlay">
  <nav class="mobile-nav" aria-label="Mobile navigation">
    <a href="#dashboard" class="mobile-nav-link active">Dashboard</a>
    <a href="#projects" class="mobile-nav-link">Projects <span class="nav-badge">7</span></a>
    <a href="#payments" class="mobile-nav-link">Payments <span class="nav-badge urgent">2</span></a>
    <a href="#messages" class="mobile-nav-link">Messages <span class="nav-badge">12</span></a>
    <div class="mobile-nav-buttons">
      <a href="user_profile.html" class="btn btn-secondary">Profile</a>
      <a href="index.html" class="btn btn-primary">Logout</a>
    </div>
  </nav>
</div>

<!-- Core JavaScript -->
<script>
// SECURITY NOTE: All user inputs should be validated and sanitized server-side
// PLACEHOLDER: Replace with actual API endpoints and proper error handling

document.addEventListener('DOMContentLoaded', () => {
  // Header scroll effect
  const header = document.getElementById('header');
  window.addEventListener('scroll', () => {
    header.classList.toggle('scrolled', window.scrollY > 50);
  });

  // Mobile menu toggle
  const mobileMenu = document.getElementById('mobile-menu');
  const mobileOverlay = document.querySelector('.mobile-nav-overlay');

  mobileMenu?.addEventListener('click', () => {
    mobileOverlay.classList.toggle('active');
    const isExpanded = mobileMenu.getAttribute('aria-expanded') === 'true';
    mobileMenu.setAttribute('aria-expanded', !isExpanded);
  });

  // Close mobile menu when clicking outside
  mobileOverlay?.addEventListener('click', (e) => {
    if (e.target === mobileOverlay) {
      mobileOverlay.classList.remove('active');
      mobileMenu?.setAttribute('aria-expanded', 'false');
    }
  });

  // Alert banner dismiss
  document.querySelector('.alert-dismiss')?.addEventListener('click', () => {
    document.querySelector('.alert-banner').style.display = 'none';
  });

  // Logo click handler removed - handled by data-action="dashboard" in navigation.js

  // Update current time every minute
  updateCurrentTime();
  setInterval(updateCurrentTime, 60000);

  // Make cards interactive
  setupCardInteractions();

  // Setup navigation
  setupNavigation();

  // Load dashboard data
  loadDashboardData();
});

// Make cards and elements interactive
function setupCardInteractions() {
  // Project cards click to expand
  document.querySelectorAll('.project-card').forEach(card => {
    card.addEventListener('click', (e) => {
      if (!e.target.closest('button')) {
        card.classList.toggle('expanded');
        const projectId = card.dataset.projectId;
        showToast(`Project details: ${card.querySelector('h3').textContent}`, 'info');
      }
    });

    // Add hover effects
    card.addEventListener('mouseenter', () => {
      card.style.transform = 'translateY(-3px)';
    });

    card.addEventListener('mouseleave', () => {
      card.style.transform = 'translateY(0)';
    });
  });

  // Urgent items interactive
  document.querySelectorAll('.urgent-item').forEach(item => {
    item.addEventListener('click', () => {
      item.classList.toggle('selected');
      const title = item.querySelector('.urgent-title').textContent;
      showToast(`Selected: ${title}`, 'info');
    });
  });

  // Timeline items interactive
  document.querySelectorAll('.timeline-item').forEach(item => {
    item.addEventListener('click', () => {
      const title = item.querySelector('.timeline-title').textContent;
      if (item.classList.contains('completed')) {
        showToast('Task already completed ‚úÖ', 'success');
      } else if (item.classList.contains('current')) {
        showToast('Working on this now... ‚ö°', 'warning');
      } else {
        showToast(`Upcoming: ${title}`, 'info');
      }
    });
  });

  // Client items interactive
  document.querySelectorAll('.client-item').forEach(item => {
    item.addEventListener('click', () => {
      const clientName = item.querySelector('.client-name').textContent;
      const clientId = clientName.split('(')[1]?.split(')')[0].toLowerCase().replace(/\s+/g, '');
      showToast(`Opening conversation with ${clientName}`, 'info');
      setTimeout(() => {
        window.location.href = `messages.html?client=${clientId}`;
      }, 1000);
    });
  });

  // Chaos feed items interactive
  document.querySelectorAll('.chaos-item').forEach(item => {
    item.addEventListener('click', () => {
      const title = item.querySelector('.chaos-title').textContent;
      showToast(`Activity: ${title}`, 'info');

      // Simulate marking as read
      setTimeout(() => {
        item.style.opacity = '0.6';
        item.style.pointerEvents = 'none';
      }, 500);
    });
  });

  // Stats interactive
  document.querySelectorAll('.stat-item').forEach(stat => {
    stat.addEventListener('click', () => {
      const label = stat.querySelector('.stat-label').textContent;
      const value = stat.querySelector('.stat-value').textContent;

      if (label === 'Overdue') {
        window.location.href = 'projects.html?filter=overdue';
      } else if (label === 'Due Today') {
        window.location.href = 'projects.html?filter=due-today';
      } else if (label === 'Week Progress') {
        showToast(`This week: ${value} of goals completed`, 'info');
      }
    });
  });
}

// Setup navigation between pages
function setupNavigation() {
  // Navigation links removed - handled by data-action attributes in navigation.js

  // Alert banner actions
  document.querySelector('.alert-action')?.addEventListener('click', () => {
    showToast('Opening payment discussion...', 'warning');
    setTimeout(() => {
      window.location.href = 'messages.html?client=techflow&urgent=payment';
    }, 1000);
  });

  // Profile navigation
  document.querySelector('.profile-mini')?.addEventListener('click', (e) => {
    e.preventDefault();
    showToast('Loading your profile...', 'info');
    setTimeout(() => {
      window.location.href = 'user_profile.html';
    }, 500);
  });
}

function updateCurrentTime() {
  const timeElement = document.querySelector('.current-time');
  if (timeElement) {
    const now = new Date();
    timeElement.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }
}

// Chaos feed items interactive
document.querySelectorAll('.chaos-item').forEach(item => {
  item.addEventListener('click', () => {
    const title = item.querySelector('.chaos-title').textContent;
    showToast(`Activity: ${title}`, 'info');

    // Simulate marking as read
    setTimeout(() => {
      item.style.opacity = '0.6';
      item.style.pointerEvents = 'none';
    }, 500);
  });
});

// Stats interactive
document.querySelectorAll('.stat-item').forEach(stat => {
  stat.addEventListener('click', () => {
    const label = stat.querySelector('.stat-label').textContent;
    const value = stat.querySelector('.stat-value').textContent;

    if (label === 'Overdue') {
      window.location.href = 'projects.html?filter=overdue';
    } else if (label === 'Due Today') {
      window.location.href = 'projects.html?filter=due-today';
    } else if (label === 'Week Progress') {
      showToast(`This week: ${value} of goals completed`, 'info');
    }
  });
});

// Setup navigation between pages
function setupNavigation() {
  // Navigation links removed - handled by data-action attributes in navigation.js

  // Alert banner actions
  document.querySelector('.alert-action')?.addEventListener('click', () => {
    showToast('Opening payment discussion...', 'warning');
    setTimeout(() => {
      window.location.href = 'messages.html?client=techflow&urgent=payment';
    }, 1000);
  });

  // Profile navigation
  document.querySelector('.profile-mini')?.addEventListener('click', (e) => {
    e.preventDefault();
    showToast('Loading your profile...', 'info');
    setTimeout(() => {
      window.location.href = 'user_profile.html';
    }, 500);
  });
}

function updateCurrentTime() {
  const timeElement = document.querySelector('.current-time');
  if (timeElement) {
    const now = new Date();
    timeElement.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }
}

// Modal functions with accessibility support
function showModal(modalId) {
  const modal = document.getElementById(`${modalId}-modal`);
  if (modal) {
    modal.classList.add('active');
    modal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';

    // Focus management
    const firstInput = modal.querySelector('input, button, textarea');
    firstInput?.focus();
  }
}

function closeModal(modalId) {
  const modal = document.getElementById(`${modalId}-modal`);
  if (modal) {
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = 'auto';
  }
}

// Close modal on escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    const activeModal = document.querySelector('.modal.active');
    if (activeModal) {
      const modalId = activeModal.id.replace('-modal', '');
      closeModal(modalId);
    }
  }
});

// DATABASE INTEGRATION: Replace with actual API calls to Azure backend
function loadDashboardData() {
  // TODO: Implement API calls to:
  // - GET /api/user/dashboard-stats (for stats widgets)
  // - GET /api/projects/active (for project cards)
  // - GET /api/payments/overdue (for payment alerts)
  // - GET /api/timeline/today (for today's schedule)
  // - GET /api/clients/health (for client relationship data)

  // Example implementation for Azure:
  /*
  fetch('/api/user/dashboard-stats', {
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${getAuthToken()}`,
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => updateDashboardStats(data))
  .catch(error => showToast('Failed to load dashboard data', 'error'));
  */
}

function createProject(event) {
  event.preventDefault();
  // PLACEHOLDER: Implement with CSRF protection and validation
  showToast('Project added to pipeline! Time to get to work üí™', 'success');
  closeModal('new-project');
}

function viewProject(projectId) {
  // Navigate to project detail (placeholder for your cousin's work)
  showToast('Opening project details...', 'info');
  setTimeout(() => {
    window.location.href = `projects.html?id=${projectId}`;
  }, 500);
}

function contactClient(clientId) {
  // Navigate to messages with client filter
  showToast('Opening messages...', 'info');
  setTimeout(() => {
    window.location.href = `messages.html?client=${clientId}`;
  }, 500);
}

function chasePayment(projectId) {
  // Interactive payment chasing
  const confirmChase = confirm('Send payment reminder to client? This will:\n\n‚Ä¢ Email a polite but firm reminder\n‚Ä¢ Update project status\n‚Ä¢ Log the interaction\n\nProceed?');

  if (confirmChase) {
    showToast('Payment reminder sent. Keep your fingers crossed! ü§û', 'warning');

    // Update UI to show action taken
    const projectCard = document.querySelector(`[data-project-id="${projectId}"]`);
    if (projectCard) {
      const activitySpan = projectCard.querySelector('.recent-activity');
      if (activitySpan) {
        activitySpan.innerHTML = 'üìß Payment reminder sent just now';
        activitySpan.className = 'recent-activity warning';
      }
    }

    // Navigate to payments page after a delay
    setTimeout(() => {
      window.location.href = `payments.html?highlight=${projectId}`;
    }, 2000);
  }
}

function chaseAllPayments() {
  const overdueCount = 2;
  const confirmChaseAll = confirm(`Send payment reminders to ${overdueCount} overdue clients?\n\nThis will:\n‚Ä¢ Email all clients with overdue payments\n‚Ä¢ Update all relevant project statuses\n‚Ä¢ Schedule follow-up reminders\n\nTotal overdue: $3,200\n\nProceed?`);

  if (confirmChaseAll) {
    showToast('All payment reminders sent. Time to follow up! üìû', 'warning');

    // Simulate sending process
    setTimeout(() => {
      showToast('‚úÖ 2 payment reminders sent successfully', 'success');
    }, 2000);

    setTimeout(() => {
      window.location.href = 'payments.html?tab=overdue';
    }, 3000);
  }
}

function sendClientUpdates() {
  const updateCount = 4;
  showToast(`Preparing ${updateCount} client updates...`, 'info');

  // Simulate update generation
  setTimeout(() => {
    showToast('Client updates sent. Transparency is key! ‚ú®', 'success');

    // Update the survival action to show completion
    const updateBtn = document.querySelector('.survival-action[onclick="sendClientUpdates()"]');
    if (updateBtn) {
      updateBtn.innerHTML = '<div class="survival-icon">‚úÖ</div><span>All Caught Up<br><small>Updates sent</small></span>';
      updateBtn.style.opacity = '0.7';
      updateBtn.onclick = null;
    }
  }, 1500);
}

function generateInvoices() {
  const invoiceCount = 2;
  showToast(`Generating ${invoiceCount} invoices...`, 'info');

  setTimeout(() => {
    showToast('Invoices generated and sent. Money incoming! üí∞', 'success');

    // Navigate to payments page
    setTimeout(() => {
      window.location.href = 'payments.html?tab=invoices';
    }, 1500);
  }, 1000);
}

function findNewWork() {
  const platforms = [
    { name: 'Upwork', url: 'https://upwork.com' },
    { name: 'Freelancer', url: 'https://freelancer.com' },
    { name: 'Fiverr', url: 'https://fiverr.com' },
    { name: 'Toptal', url: 'https://toptal.com' }
  ];

  const choice = confirm('Where do you want to hunt for new projects?\n\nOK = Open job platforms\nCancel = Add project manually');

  if (choice) {
    showToast('Opening job platforms. Good hunting! üéØ', 'info');
    // Open multiple platforms
    platforms.forEach((platform, index) => {
      setTimeout(() => {
        window.open(platform.url, '_blank');
      }, index * 500);
    });
  } else {
    showModal('new-project');
  }
}

function showToast(message, type = 'info') {
  // Check for existing toasts to stack them
  const existingToasts = document.querySelectorAll('.toast');
  const toastHeight = 60; // Approximate height including margins
  const topOffset = 20 + (existingToasts.length * toastHeight);

  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;

  // Style the toast with calculated position
  Object.assign(toast.style, {
    position: 'fixed',
    top: `${topOffset}px`,
    right: '20px',
    padding: '12px 20px',
    backgroundColor: type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#6366f1',
    color: 'white',
    borderRadius: '8px',
    boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
    zIndex: '10000',
    transform: 'translateX(100%)',
    transition: 'all 0.3s ease',
    maxWidth: '300px',
    fontSize: '14px',
    marginBottom: '8px'
  });

  document.body.appendChild(toast);

  // Animate in
  setTimeout(() => {
    toast.style.transform = 'translateX(0)';
  }, 100);

  // Remove after delay and update remaining toasts positions
  setTimeout(() => {
    toast.style.transform = 'translateX(100%)';
    setTimeout(() => {
      if (document.body.contains(toast)) {
        document.body.removeChild(toast);
        // Reposition remaining toasts
        updateToastPositions();
      }
    }, 300);
  }, 4000);
}

function updateToastPositions() {
  const remainingToasts = document.querySelectorAll('.toast');
  const toastHeight = 60;

  remainingToasts.forEach((toast, index) => {
    const newTop = 20 + (index * toastHeight);
    toast.style.top = `${newTop}px`;
  });
}
</script>

<script src="/js/api.js"></script>
<script src="/js/navigation.js"></script>
<script src="/js/button_logic.js"></script>
<script>
// Enhanced Dashboard with PostgreSQL Integration
document.addEventListener('DOMContentLoaded', async function() {
    // Wait for API to be fully loaded before checking authentication
    let attempts = 0;
    const maxAttempts = 10;

    while (!window.LunaraAPI && attempts < maxAttempts) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
    }

    // Authentication check - redirect if not logged in
    if (!window.LunaraAPI || !window.LunaraAPI.isAuthenticated()) {
        // Give the API one more moment to initialize from localStorage
        setTimeout(() => {
            if (!window.LunaraAPI || !window.LunaraAPI.isAuthenticated()) {
                window.location.href = 'signin.html';
            } else {
                // API is ready now, initialize dashboard
                initializeDashboard();
            }
        }, 200);
        return;
    }

    // Initialize dashboard with real-time data
    await initializeDashboard();

    // Set up auto-refresh for real-time updates
    setupAutoRefresh();

    // Set up project creation form
    setupProjectCreation();
});

async function initializeDashboard() {
    try {
        // Show loading state
        showLoadingState();

        // Fetch real data from PostgreSQL-backed API
        const dashboardData = await window.LunaraAPI.refreshDashboardData();

        // Update all dashboard components with real data
        updateDashboardStats(dashboardData.stats);
        updateProjectsList(dashboardData.projects);
        updateUserInfo();

        // Hide loading state
        hideLoadingState();

    } catch (error) {
        console.error('Dashboard initialization error:', error);
        handleAPIError(error, 'Dashboard initialization');

        // Fallback to existing static data if API fails
        hideLoadingState();
    }
}

function updateDashboardStats(stats) {
    // Update stat items with real PostgreSQL data
    const statMappings = {
        'overdue-tasks': stats.overdue_tasks,
        'due-today': stats.due_today,
        'weekly-progress': stats.week_progress
    };

    Object.entries(statMappings).forEach(([statKey, value]) => {
        const statElement = document.querySelector(`[data-stat="${statKey}"]`);
        if (statElement) {
            const valueElement = statElement.querySelector('.stat-value');
            if (valueElement) {
                valueElement.textContent = statKey === 'weekly-progress' ? `${value}%` : value;
                valueElement.setAttribute('data-count', value);
            }
        }
    });

    // Update additional stats (can be displayed elsewhere)
    updateAdditionalStats(stats);
}

function updateAdditionalStats(stats) {
    // Update navigation badges with real counts
    updateNavigationBadges(stats);

    const additionalStats = {
        totalProjects: stats.total_projects,
        activeProjects: stats.active_projects,
        completedProjects: stats.completed_projects,
        totalEarned: stats.total_earned,
        pendingPayments: stats.pending_payments,
        successRate: stats.success_rate
    };

    console.log('Additional stats from PostgreSQL:', additionalStats);
}

function updateNavigationBadges(stats) {
    // Update Projects badge
    const projectsBadge = document.getElementById('projects-badge');
    if (projectsBadge && stats.active_projects > 0) {
        projectsBadge.textContent = stats.active_projects;
        projectsBadge.style.display = 'inline-block';
    }

    // Update Payments badge (urgent if there are pending payments)
    const paymentsBadge = document.getElementById('payments-badge');
    if (paymentsBadge && stats.pending_payments > 0) {
        paymentsBadge.textContent = stats.pending_payments;
        paymentsBadge.style.display = 'inline-block';
        // Keep urgent class if there are overdue payments
        if (stats.overdue_tasks > 0) {
            paymentsBadge.classList.add('urgent');
        }
    }

    // Messages badge will be updated when we add messaging system
    // For now, hide it
    const messagesBadge = document.getElementById('messages-badge');
    if (messagesBadge) {
        messagesBadge.style.display = 'none';
    }
}

function updateProjectsList(projects) {
    const container = document.getElementById('project-list-container');
    const emptyState = document.getElementById('projects-empty-state');
    const viewAllLink = document.getElementById('view-all-projects');

    if (!projects || projects.length === 0) {
        // Show empty state
        if (emptyState) emptyState.style.display = 'block';
        if (viewAllLink) viewAllLink.style.display = 'none';
        console.log('No projects to display');
        return;
    }

    // Hide empty state and show view all link
    if (emptyState) emptyState.style.display = 'none';
    if (viewAllLink) {
        viewAllLink.textContent = `View All (${projects.length})`;
        viewAllLink.style.display = 'inline-block';
    }

    // Clear container except empty state
    Array.from(container.children).forEach(child => {
        if (child.id !== 'projects-empty-state') {
            child.remove();
        }
    });

    // Render each project
    projects.forEach(project => {
        const projectCard = createProjectCard(project);
        container.appendChild(projectCard);
    });

    console.log('Rendered projects from PostgreSQL:', projects);
}

function createProjectCard(project) {
    const card = document.createElement('div');
    card.className = 'project-card';
    card.dataset.projectId = project.id;
    card.setAttribute('role', 'article');

    // Determine status styling
    const statusClass = getStatusClass(project.status);
    card.classList.add(statusClass);

    // Format currency
    const amount = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: project.currency || 'USD'
    }).format(project.total_amount);

    // Format deadline
    const deadline = new Date(project.deadline);
    const now = new Date();
    const daysUntil = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
    const deadlineText = formatDeadline(daysUntil, deadline);

    // Get client/freelancer name
    const otherParty = project.client || project.freelancer || { username: 'Unknown' };
    const otherPartyName = otherParty.first_name
        ? `${otherParty.first_name} ${otherParty.last_name || ''}`.trim()
        : otherParty.username;

    card.innerHTML = `
        <div class="project-header">
            <div class="project-info">
                <h3>${escapeHtml(project.title)}</h3>
                <span class="client-name">${escapeHtml(otherPartyName)}</span>
            </div>
            <span class="project-status ${project.status}">
                ${getStatusIcon(project.status)} ${project.status.toUpperCase().replace('_', ' ')}
            </span>
        </div>
        <div class="project-progress">
            <div class="progress-info">
                <span>${escapeHtml(project.description).substring(0, 60)}${project.description.length > 60 ? '...' : ''}</span>
                <span class="progress-percentage">${project.progress_percentage || 0}%</span>
            </div>
            <div class="progress-bar" role="progressbar" aria-valuenow="${project.progress_percentage || 0}" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-fill" style="width: ${project.progress_percentage || 0}%"></div>
            </div>
        </div>
        <div class="project-meta">
            <span class="project-value">${amount}</span>
            <span class="project-deadline ${daysUntil < 0 ? 'overdue' : daysUntil < 3 ? 'critical-time' : 'normal'}">
                ${deadlineText}
            </span>
        </div>
        <div class="project-actions">
            <button class="btn-sm btn-primary" onclick="viewProject('${project.id}')">View Project</button>
        </div>
    `;

    return card;
}

function getStatusClass(status) {
    const statusMap = {
        'draft': 'draft',
        'active': 'smooth-sailing',
        'completed': 'payment-pending',
        'cancelled': 'cancelled',
        'paused': 'paused'
    };
    return statusMap[status] || '';
}

function getStatusIcon(status) {
    const iconMap = {
        'draft': 'üìù',
        'active': 'üöÄ',
        'completed': '‚úÖ',
        'cancelled': '‚ùå',
        'paused': '‚è∏Ô∏è'
    };
    return iconMap[status] || 'üìã';
}

function formatDeadline(daysUntil, deadline) {
    if (daysUntil < 0) {
        return `<span class="deadline-icon">üí∏</span> ${Math.abs(daysUntil)} days overdue`;
    } else if (daysUntil === 0) {
        return `<span class="deadline-icon pulse">‚è∞</span> Due today`;
    } else if (daysUntil === 1) {
        return `<span class="deadline-icon pulse">‚è∞</span> Due tomorrow`;
    } else if (daysUntil < 7) {
        return `<span class="deadline-icon">‚è∞</span> Due in ${daysUntil} days`;
    } else {
        return `<span class="deadline-icon">üìÖ</span> Due ${deadline.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function updateUserInfo() {
    const user = window.LunaraAPI.getCurrentUser();
    if (user) {
        // Update header user name
        const userNameHeader = document.getElementById('user-name-header');
        if (userNameHeader) {
            userNameHeader.textContent = user.first_name || user.username;
        }

        // Update header avatar
        const userAvatarHeader = document.getElementById('user-avatar-header');
        if (userAvatarHeader && user.profile && user.profile.avatar) {
            userAvatarHeader.src = user.profile.avatar;
            userAvatarHeader.alt = `${user.first_name || user.username}'s avatar`;
        }

        // Update dashboard greeting
        const greeting = document.getElementById('dashboard-greeting');
        if (greeting) {
            const dayOfWeek = new Date().toLocaleDateString('en-US', { weekday: 'long' });
            const greetings = [
                `${dayOfWeek} grind, ${user.first_name || user.username}! ‚ö°`,
                `Happy ${dayOfWeek}, ${user.first_name || user.username}! üöÄ`,
                `Let's crush ${dayOfWeek}, ${user.first_name || user.username}! üí™`,
                `${dayOfWeek} hustle, ${user.first_name || user.username}! ‚ú®`
            ];
            greeting.textContent = greetings[Math.floor(Math.random() * greetings.length)];
        }

        console.log('Current user from PostgreSQL:', user);
    }
}

function setupAutoRefresh() {
    // Set up real-time updates every 30 seconds
    window.DashboardAutoRefresh.start(async () => {
        try {
            const dashboardData = await window.LunaraAPI.refreshDashboardData();
            updateDashboardStats(dashboardData.stats);
            updateProjectsList(dashboardData.projects);
        } catch (error) {
            console.error('Auto-refresh error:', error);
        }
    });
}

function setupProjectCreation() {
    const createProjectForm = document.getElementById('create-project-form');
    if (createProjectForm) {
        createProjectForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(createProjectForm);
            const projectData = {
                title: formData.get('title'),
                description: formData.get('description'),
                total_amount: parseFloat(formData.get('budget')),
                currency: 'USD',
                deadline: new Date(formData.get('deadline')).toISOString(),
                project_type: formData.get('category') || 'web_development',
                skills_required: formData.get('skills') || ''
            };

            try {
                // Show loading state
                const submitButton = createProjectForm.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'Creating Project...';

                // Create project in PostgreSQL
                const newProject = await window.LunaraAPI.createProject(projectData);

                // Show success message
                showToast('Project created successfully!', 'success');

                // Close modal and refresh dashboard
                closeProjectModal();
                await initializeDashboard();

                // Reset form
                createProjectForm.reset();

                // Reset button state
                submitButton.disabled = false;
                submitButton.textContent = originalText;

            } catch (error) {
                console.error('Project creation error:', error);
                handleAPIError(error, 'Project creation');

                // Reset button state
                const submitButton = createProjectForm.querySelector('button[type="submit"]');
                submitButton.disabled = false;
                submitButton.textContent = 'Create Project';
            }
        });
    }
}

// Modal management with accessibility: focus trap
function closeProjectModal() {
  const modal = document.querySelector('.create-project-modal');
  if (modal) {
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = 'auto';
    // Remove focus trap
    document.removeEventListener('keydown', trapModalFocus);
  }
}

function trapModalFocus(e) {
  const modal = document.querySelector('.create-project-modal[aria-hidden="false"]');
  if (!modal) return;
  const focusable = modal.querySelectorAll('input, button, textarea, [tabindex]:not([tabindex="-1"])');
  const first = focusable[0];
  const last = focusable[focusable.length - 1];
  if (e.key === 'Tab') {
    if (e.shiftKey && document.activeElement === first) {
      e.preventDefault();
      last.focus();
    } else if (!e.shiftKey && document.activeElement === last) {
      e.preventDefault();
      first.focus();
    }
  }
}

function openProjectModal() {
  const modal = document.querySelector('.create-project-modal');
  if (modal) {
    modal.style.display = 'block';
    modal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
    // Focus trap
    document.addEventListener('keydown', trapModalFocus);
    // Focus first input
    const firstInput = modal.querySelector('input, button, textarea');
    firstInput?.focus();
  }
}

// Show loading indicators using dashboardState
function showLoadingState() {
  dashboardState.loading = true;
  document.querySelectorAll('.stat-value').forEach(el => {
    el.style.opacity = '0.5';
  });
}

// Hide loading indicators using dashboardState
function hideLoadingState() {
  dashboardState.loading = false;
  document.querySelectorAll('.stat-value').forEach(el => {
    el.style.opacity = '1';
  });
}

// Enhanced logout function with error handling
function handleLogout() {
  try {
    window.LunaraAPI.logout();
  } catch (error) {
    showToast('Logout failed. Please try again.', 'error');
  }
}

// Update logout button to use the API
document.addEventListener('DOMContentLoaded', function() {
  const logoutButton = document.querySelector('.btn-secondary[href="index.html"]');
  logoutButton?.addEventListener('click', function(e) {
    e.preventDefault();
    handleLogout();
  });
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
  window.DashboardAutoRefresh?.stop();
});

// Central dashboard state object
const dashboardState = {
  loading: false,
  stats: {},
  projects: [],
  user: null
};

// Toast notification with aria-live
function showToast(message, type = 'info') {
  const existingToasts = document.querySelectorAll('.toast');
  const toastHeight = 60;
  const topOffset = 20 + (existingToasts.length * toastHeight);
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  toast.setAttribute('role', 'alert');
  toast.setAttribute('aria-live', 'polite');
  Object.assign(toast.style, {
    position: 'fixed',
    top: `${topOffset}px`,
    right: '20px',
    padding: '12px 20px',
    backgroundColor: type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#6366f1',
    color: 'white',
    borderRadius: '8px',
    boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
    zIndex: '10000',
    transform: 'translateX(100%)',
    transition: 'all 0.3s ease',
    maxWidth: '300px',
    fontSize: '14px',
    marginBottom: '8px'
  });
  document.body.appendChild(toast);
  setTimeout(() => { toast.style.transform = 'translateX(0)'; }, 100);
  setTimeout(() => {
    toast.style.transform = 'translateX(100%)';
    setTimeout(() => {
      if (document.body.contains(toast)) {
        document.body.removeChild(toast);
        updateToastPositions();
      }
    }, 300);
  }, 4000);
}

function updateToastPositions() {
  const remainingToasts = document.querySelectorAll('.toast');
  const toastHeight = 60;
  remainingToasts.forEach((toast, index) => {
    const newTop = 20 + (index * toastHeight);
    toast.style.top = `${newTop}px`;
  });
}
</script>

</body>
</html>