name: Deploy Backend to Azure Container Instances

on:
  push:
    branches: [ master, main ]
    paths: [ 'backend/**', '.github/workflows/backend-deploy.yml' ]
  workflow_dispatch:

env:
  REGISTRY_NAME: lunaraappregistry
  RESOURCE_GROUP: lunara-app-rg
  CONTAINER_NAME: lunara-app-backend
  IMAGE_NAME: lunara-backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Build and push Docker image
      run: |
        # Login to ACR
        az acr login --name ${{ env.REGISTRY_NAME }}

        # Get ACR login server
        ACR_LOGIN_SERVER=$(az acr show --name ${{ env.REGISTRY_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query loginServer --output tsv)

        # Build and push image
        docker build -t $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:${{ github.sha }} ./backend/
        docker push $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:${{ github.sha }}

        # Tag as latest
        docker tag $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:${{ github.sha }} $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:latest
        docker push $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:latest

    - name: Deploy to Container Instance
      run: |
        # Get ACR credentials
        ACR_USERNAME=$(az acr credential show --name ${{ env.REGISTRY_NAME }} --query username --output tsv)
        ACR_PASSWORD=$(az acr credential show --name ${{ env.REGISTRY_NAME }} --query passwords[0].value --output tsv)
        ACR_LOGIN_SERVER=$(az acr show --name ${{ env.REGISTRY_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query loginServer --output tsv)

        # Create container instance
        az container create \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.CONTAINER_NAME }} \
          --image $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:latest \
          --os-type Linux \
          --cpu 1 \
          --memory 1 \
          --registry-login-server $ACR_LOGIN_SERVER \
          --registry-username $ACR_USERNAME \
          --registry-password $ACR_PASSWORD \
          --dns-name-label ${{ env.CONTAINER_NAME }} \
          --ports 8000 \
          --environment-variables \
            SECRET_KEY="${{ secrets.DJANGO_SECRET_KEY }}" \
            DEBUG="False" \
            DB_NAME="${{ secrets.DB_NAME }}" \
            DB_USER="${{ secrets.DB_USER }}" \
            DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            DB_HOST="${{ secrets.DB_HOST }}" \
            DB_PORT="${{ secrets.DB_PORT }}" \
            DJANGO_SETTINGS_MODULE="safesend.settings.production" \
          --location eastus \
          --restart-policy Always \
          --no-wait

    - name: Verify deployment
      run: |
        echo "Waiting for container to start..."
        sleep 60

        CONTAINER_FQDN=$(az container show \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.CONTAINER_NAME }} \
          --query ipAddress.fqdn \
          --output tsv)

        echo "Backend deployed to: https://$CONTAINER_FQDN:8000"

        # Test health endpoint
        curl -f "https://$CONTAINER_FQDN:8000/health/" || echo "Health check failed"