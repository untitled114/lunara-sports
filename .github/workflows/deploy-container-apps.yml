name: Deploy Backend to Azure Container Apps

on:
  push:
    branches: [ master ]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-container-apps.yml'
  workflow_dispatch:

env:
  REGISTRY_NAME: lunaraappregistry
  RESOURCE_GROUP: lunara-app-rg
  CONTAINER_APP_NAME: lunara-backend
  CONTAINER_APP_ENV: lunara-env
  IMAGE_NAME: lunara-backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Azure Container Apps extension
        run: |
          az extension add --name containerapp --upgrade || true
          az provider register --namespace Microsoft.App || true
          az provider register --namespace Microsoft.OperationalInsights || true

      - name: Build and push Docker image
        run: |
          echo "üî® Building and pushing Docker image..."
          az acr login --name ${{ env.REGISTRY_NAME }}
          ACR_LOGIN_SERVER=$(az acr show --name ${{ env.REGISTRY_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query loginServer --output tsv)

          # Build image
          docker build -t $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:${{ github.sha }} ./backend/
          docker build -t $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:latest ./backend/

          # Push images
          docker push $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:latest

          echo "‚úÖ Image pushed: $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:latest"

      - name: Deploy to Container Apps
        run: |
          echo "üöÄ Deploying to Azure Container Apps..."
          ACR_LOGIN_SERVER=$(az acr show --name ${{ env.REGISTRY_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query loginServer --output tsv)

          echo "üìã Using image: $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:latest"
          echo "üìã Target container app: ${{ env.CONTAINER_APP_NAME }}"

          # Check if container app exists
          if az containerapp show --name ${{ env.CONTAINER_APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} &>/dev/null; then
            echo "‚úÖ Container app exists, updating..."

            # Update container app with new image
            az containerapp update \
              --name ${{ env.CONTAINER_APP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:latest \
              --set-env-vars \
                "SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}" \
                "DEBUG=False" \
                "DB_NAME=${{ secrets.DB_NAME }}" \
                "DB_USER=${{ secrets.DB_USER }}" \
                "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" \
                "DB_HOST=${{ secrets.DB_HOST }}" \
                "DB_PORT=${{ secrets.DB_PORT }}" \
                "DJANGO_SETTINGS_MODULE=safesend.settings.production"

            echo "‚úÖ Container App updated successfully"
          else
            echo "‚ùå Container app ${{ env.CONTAINER_APP_NAME }} not found in resource group ${{ env.RESOURCE_GROUP }}"
            echo "üìã Available container apps:"
            az containerapp list --resource-group ${{ env.RESOURCE_GROUP }} --query "[].{name:name,status:properties.provisioningState}" --output table || true
            exit 1
          fi

      - name: Get deployment status
        run: |
          echo "üìä Checking deployment status..."
          az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.{provisioningState:provisioningState,latestRevisionName:latestRevisionName,fqdn:configuration.ingress.fqdn}" \
            --output table

          BACKEND_URL=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv)

          echo "üåê Backend URL: https://$BACKEND_URL"
          echo "‚úÖ Backend deployment complete!"

  test-deployment:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Test backend health
        run: |
          echo "üîç Testing backend health..."
          BACKEND_URL=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv)

          echo "Backend URL: https://$BACKEND_URL"

          # Wait for deployment to be ready
          echo "‚è≥ Waiting for deployment to be ready..."
          sleep 30

          # Test health endpoint
          echo "üîÑ Testing health endpoint..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://$BACKEND_URL/api/auth/check-email/?email=test@example.com" || echo "000")

          if [[ $HTTP_STATUS == "405" || $HTTP_STATUS == "200" ]]; then
            echo "‚úÖ Backend is responding (HTTP $HTTP_STATUS)"
          else
            echo "‚ùå Backend not responding (HTTP $HTTP_STATUS)"
            echo "üîç Let's check the container app status..."
            az containerapp show --name ${{ env.CONTAINER_APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query "properties.provisioningState" --output tsv
          fi